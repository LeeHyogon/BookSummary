# 3.1 어째서 캐시가 필요한 것인가?

- 디스크는 액추에이터(톤암)를 움직여서 데이터를 읽고 씁니다. 오라클은 디스크에게 읽고 쓰는 것을 의뢰한다. 
- 오라클은 여러 개의 프로세스로 구성되어 있고 SQL문을 동시에 처리할 수 있다.
- 또한 프로세스에는 각자의 역할이 있으며, SQL문을 빠르게 처리하는 서버프로세스와 그것을 지원하는 백그라운드 프로세스가 존재한다..
- 1장에서 디스크가 동작하는 것은 매우 느리고 I/O 1회에 10~ 20 ms 정도 걸린다고 언급. 그래서 오라클은 '캐시'라고 불리는 기술을 사용해 가능한한 메모리에서 처리하는 구조를 갖고 있다.

# 3.2 그래서 캐시란 무엇인가?

- 디스크의 데이터를 처리해야 할 때 메모리(캐시)에 같은 데이터가 존재하면 디스크에서 읽을 필요 없이 CPU에게 데이터를 직접 건네줄 수 있음.
- CPU캐시는 속도가 빠르지만 가격이 가장 비싸다. 지금 나오는 캐시(메모리)와는 관계가 없다.

다음으로 오라클에서 데이터 캐시(버퍼 캐시) 동작을 보자.
- 서버 프로세스가 원하는 데이터가 버퍼 캐시에 존재할 때 데이터를 빠르게 꺼내와서 처리가능. 없다면 데이터를 디스크에서 읽어 옴

# 3.3 데이터는 블록 단위로 관리
- 오라클은 '블록'이라고 하는 단위로 데이터를 관리한다.
- I/O의 단위도 블록을 기반으로 하고 있으며, 버퍼 캐시도 블록 단위로 관리하고 있다. 오라클에서 말하는 블록은 OS의 블록이 아니라 독자적인 블록을 말한다.

# 3.4 캐시를 사용해서 인덱스 검색을 효율적으로
- 테이블뿐만 아니라 인덱스도 블록으로 구성. 인덱스를 한 블록에 보관할 수 없을 때는 여러 개의 블록으로 구성. 

# 3.5 프로세스는 캐시를 공유
- 프로세스마다 캐시를 가지면 낭비가 많아지고, 다른 프로세스에서 변경된 데이터를 볼 수 없는 등, 여러 문제가 발생. 그래서 어떠한 오라클 프로세스라도 볼 수 있는 메모리를 캐시로 활용함.
- OS에서 다른 프로세스의 메모리를 보는 것은 기본적으로 불가능. OS가 메모리 안의 데이터를 손상되지 않도록 보호하고 있기 때문. 이러면 DBMS 입장에서 불편함이 발생할 수 밖에 없으므로, OS는 '공유 메모리'라는 특수한 메모리 기능을 제공한다. 공유 메모리를 사용하면 자신의 메모리 영역에 기록했던 데이터를 다른 프로세스에서도 즉시 볼 수 있다.
- 공유 메모리를 이해하기 위한 중요 포인트는 '실제 메모리는 한 개다' 라는 개념.
- 각 프로세스에게는 마치 자신의 메모리인 것처럼 보이지만, 실제로는 모든 프로세스가 같은 메모리 영역에 접근하고 있는 것. 오라클에서른 이런 공유 메모리를 'SGA(System Global Area)', 공유하지 않는 메모리의 일부를 'PGA(Program Global Area)'라고 부른다.
- DBMS에게 공유 메모리는 매우 편리한 도구이자, 다수 프로세스로 구성되므로 필수 기능. 하지만 공유 메모리에 누구든지 접근할 수 있으므로 Lock을 걸어 배타적 제어를 해야 함.
- DBMS가 Lock이 복잡하게 얽힌 내부 구조를 가지므로, 성능 문제가 발생하기 쉽다.

# 3.8 버퍼 캐시를 정리하는 LRU 알고리즘
- 버퍼 캐시는 자주 사용하는 데이터를 더 빠르게 가져오기 위해 존재. 또한, 버퍼 캐시의 크기는 한정되어 있으므로, 누군가가 어떤식으로 관리해야 함.
- 일반적으로 오라클은 LRU알고리즘을 사용
- 오라클은 LRU를 토대로 블록의 목록을 가지고 있으며, 어떤 블록이 최근에 사용되지 않았는지를 파악하고 있다. 데이터를 읽어오는 것만이라면 이 동작으로도 충분하지만, 오라클의 서버 프로세스는 변경한 데이터(블록)도 캐시에 둔다. 서버 프로세스는 디스크에 기록을 하지 않기 때문에 백그라운드 프로세스의 DBWR가 정기적으로 변경한 데이터를 디스크에 부하를 주지 않도록 조심하면서 디스크에 저장.
- 변경한 데이터는 디스크에 기록하기 전에 캐시에서 버리면 데이터가 손실되므로, 캐시에서 버려지기 전에 디스크에 기록해둠.
- 데이터가 많은 테이블을 풀 스캔한 데이터는 적재해두더라도 사용하는 경우가 별로 없고, 자주 사용하는 데이터를 캐시에서 쫓아내는 일이 발생하므로 오라클은 큰 테이블이라고 판단하면 버퍼 캐시로 블록을 적재하지 않으며, 풀 스캔했을 때의 데이터는 일반적으로 버퍼 캐시에 적재되지 않는다.
- 
