![image](https://github.com/LeeHyogon/BookSummary/assets/45483116/0b967b6c-275f-42a0-838b-2889bbe0988b)

# 8.3 B-Tree 인덱스
- 가장 범용적인 인덱스 알고리즘
- 인덱스 구조체 내에서 항상 정렬된 상태로 유지.

## 8.3.1 구조 및 특성
![image](https://github.com/LeeHyogon/BookSummary/assets/45483116/aa99b130-3a5b-46e7-9ec3-c21965797f96)

- 루트 노드-브랜치노드-리프노드 구조
- 인덱스의 리프 노드는 항상 실제 데이터 레코드를 찾아가기 위한 주솟값을 가짐
- 인덱스의 키 값은 모두 정렬되어 있음 (데이터 파일의 레코드는 정렬x)

> 대부분 RDBMS의 데이터 파일에서 레코드는 특정 기준으로 정렬되지 않고 임의의 순서로 저장되지만, InnoDB 테이블에서 레코드는 클러스터되어 디스크에 저장되므로 기본적으로 프라이머리 키 순서로 정렬되어 저장된다.

 - 인덱스는 테이블의 키 칼럼만 가지고 있으므로, 나머지 칼럼을 읽으려면 데이터 파일에서 해당 레코드를 찾아야 한다.
 - MyISAM 테이블의 인덱스는 레코드가 데이터 파일 내의 위치(Offset)이다. (ROWID)

## 8.3.2 B-Tree 인덱스 키 추가 및 삭제

### 8.3.2.1 인덱스 키 추가
- 새로운 키 값이 B-Tree에 저장될 때 새로운 키 값이 즉시 인덱스에 저장될 수도 있고 그렇지 않을 수도 있다.
- B-Tree에 저장될 때는 저장될 키 값을 이용해 B-Tree상의 적절한 위치를 검색해야 함. 저장될 위치가 결정되면 레코드의 키 값과 대상 레코드의 주소 정보를 B-Tree의 리프 노드에 저장한다.
- 리프 노드가 꽉찬 경우, Split돼야 하는데 이는 상위 브랜치 노드까지 처리의 범위가 넓어지므로 쓰기 작업(새로운 키 추가 작업)에 비용이 많이 든다.
- InnoDB 스토리지 엔진은 작업을 지능적으로 처리(필요하다면 인덱스 키 추가 작업을 지연시켜 나중에 처리 가능). 하지만 pk 나 unique index의 경우 중복체크를 위하여 즉시 추가하거나 삭제.

#### 대략적인 인덱스 연산 비용
테이블에 레코드 추가하는 작업 비용 1 가정.
해당 테이블에 인덱스에 키를 추가하는 작업 비용은 1.5로 예측
테이블에 인데스가 3개인 경우 5.5(1.5*3+1)정도로 예측. 
**이 비용의 대부분은 디스크로 부터 인덱스 페이지를 읽고 쓰기를 해야 해서 걸리는 시간임** 

### 8.3.2.2 인덱스 키 삭제
- 해당 키 값이 저장된 B-Tree의 리프 노드를 찾아서 그냥 삭제 마크만 하면 완료. 이렇게 삭제 마킹된 인덱스 키 공간은 방치하거나 재활용 가능.
- InnoDB 스토리지 엔진은 작업을 지능적으로 처리(필요하다면 인덱스 키 삭제 작업을 지연시켜 나중에 처리 가능). 하지만 pk 나 unique index의 경우 중복체크를 위하여 즉시 추가하거나 삭제.

### 8.3.2.3 인덱스 키 변경
- 인덱스의 키 값은 그 값에 따라 저장될 리프 노드의 위치가 결정되므로 B-Tree의 키 값이 변경되는 경우 단순히 인덱스상의 키 값만 변경하는 것은 불가능.
- 먼저 키 값을 삭제한 후, 다시 새로운 키 값을 추가하는 형태로 처리됨.
- InnoDB의 경우 이 작업 모두 체인지 버퍼를 활요해 지연 처리 가능(삽입,삭제와 동일)

### 8.3.2.4 인덱스 키 검색
- 데이터 삽입,수정,삭제 작업 시 추가 비용을 감당하는 이유는 빠른 조회 때문.
- 인덱스 트리 탐색은 100% 일치 or 값의 앞부분만 일치 or 부등호 비교 조건에서 활용할 수 있지만, 키 값 뒷부분만 검색하는 용도로는 사용x.
- InnoDB 테이블에서 지원하는 레코드 잠금이나 넥스트 키락(갭락)이 검색을 수행한 인덱스를 잠근 후 테이블의 레코드를 잠그는 방식으로 구현돼 있음. 따라서 수정이나 삭제가 실행될 때 적절히 사용할 수 있는 인덱스가 없으면 불필요하게 많은 레코드를 잠금.**설계가 중요하고 많은 부분에 영향**

 ## 8.3.3 B-Tree 인덱스 사용에 영향을 미치는 요소
 - 인덱스를 구성하는 칼럼 크기, 레코드 건수, 유니크한 인덱스 키 값의 개수 등에 의해 검색 변경 작업 성능이 영향을 받음.



